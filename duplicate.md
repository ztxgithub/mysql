# Mysql复制

## Mysql复制概念

```shell
    Mysql复制功能提供了分担 读负载，通过复制功能对数据库进行水平扩展，为数据库服务器增加一个或多个备库，这些备库可以分担读负载。
    Mysql复制功能为高可用，灾难恢复，备份提供更多的选择。
    Mysql的复制是基于主库上的二进制日志，Mysql的复制是异步的，可以存在主从数据库不一致，
    
    Mysql复制所解决的问题:
        (1) 实现在不同服务器上的数据分布(Mysql复制是利用二进制日志增量进行，不需要太多的带宽，但是使用基于行的复制在进行大批量的
                                     更改时会对带宽带来一定的压力，应该分批进行)
        (2) 实现数据读取的负载均衡(需要其他组件配合完成，例如利用DNS轮询的方式把程序的读 连接到不同的备份数据库中，
                                也可以使用LVS，haproxy等方式)
        (3) 增加数据的安全性(复制并不能代替备份，复制只是将主库的数据拷贝到从库中，由于主从同步的延时小，如果主库中有大量错误数据，
                           则从库也很快被同步扩散，不能通过从库恢复到主库，而是得用备份的方式)
        (4) 实现数据库高可用和故障切换。
        (5) 实现数据库的在线升级
        

```

## Mysql二进制日志

```shell
    Mysql日志类型:
        (1) MySQL服务层日志
                例如二进制日志，慢查日志，通用日志，这些日志与存储引擎无关，是由MySQL服务器层来记录的，
        (2) MySQL存储引擎层日志：例如innodb重做日志和innodb回滚日志
        
    二进制日志(binlog)
        记录了所有对MySQL数据库的修改事件，包括增删改查事件和对表结构的修改事件,在binlog日志中记录的事件都是已经成功执行的，对于已经
        回滚的事件不会记录在binlog日志中
        
    二进制日志的格式
        (1) 基于段的格式 
                特点:
                    数据库系统变量binlog_format = STATEMENT,  其记录的是执行的SQL语句,如果数据库采用这种方式，在终端执行
                    mysqlbinlog命令时不需要指定任何参数，就可以清楚得从二进制日志中看出执行了那些二进制语句，
                    不管数据库系统变量binlog_format 是何值，在进行 DDL(表结构操作)时都是用基于段的格式记录在biglog中.
                    
                优点:
                    1.日记记录量相对较小(记录的只是每一个事件的SQL语句)，节约磁盘及网络I/O，只对一条记录修改或则插入，row格式
                      所产生的日志量小于 段产生的日志量
                
                缺点:
                    1.必须记录上下文信息，保证语句在从服务器上执行结果和在主服务器上相同。但是特定函数如UUID(),user(),这样非确定性
                      函数还是无法复制，这可能造成MySQL复制的主备服务器数据不一致。
                        
                        
        (2) 基于行的格式 
                特点:
                    数据库系统变量binlog_format = ROW（MySQL的默认使用格式）,Row可以避免MySQL复制中出现的主从不一致问题，推荐使用
                    这种二进制日志格式，这种日志记录的是增删改查操作所修改数据行的信息，每修改一行就会有一条记录，同一条SQL语句修改了
                    10000条数据的情况下，基于段的二进制日志格式只会记录这个SQL语句，而基于行的二进制日志格式会有10000条记录分别记录
                    每一个行的数据修改
                    
                优点:
                    1.使MySQL主从复制更加安全，由于ROW格式记录每一个记录的修改，所以传到从服务器上只需要应用其更改就行了，而不是按照
                      SQL语句进行应用，在主服务器该了什么，同样的也会在从服务器更改相同的地方，确保主从数据一致。
                    2.ROW格式是记录了每一行的修改，这要比基于段格式的复制要高效，减低主从复制的时间
                    3.误操作而修改了数据库的数据，同时又没有备份可以恢复时，我们就可以通过分析ROW格式二进制日志，
                      对日志中记录的数据修改操作做反向处理的方式来达到恢复数据的目的
                
                缺点:
                    1.记录日志量大，消耗更多的磁盘IO和网络IO
                    
        (3) 混合日志格式
                特定:
                    数据库系统变量binlog_format = MIXED,它是基于段的日志格式和行的日志格式的折衷的选择，
                    1.根据SQL语句由系统决定在基于段的日志格式和基于在行的日志格式中进行选择
    
        
    命令 mysqlbinlog 
       (1) 如果binlog的格式是 段格式(statement)  > mysqlbinlog 二进制日志
    

```

## MySQL 二进制日志相关的参数

```shell
    1.对于 ROW格式的二进制日志 
            binlog_row_image 值
                (1) FULL(默认的): 一行数据修改时会记录这行所有列的内容，无论这些列是否都被修改过
                (2) MINIMAL: 一行数据修改时只会记录 被修改的列，如果数据库表中有20，SQL操作只update其中这一列，则只会记录这一列的内容
                (3) NOBLOB:跟FULL一样，只不过当text和BLOB没有修改时，是不会记录的
    

```

